{%extends 'health/dashboard_base.html' %}
{% load static %}

{% block content %}
<style>
 .doctors-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
    gap: 24px;
    padding: 20px;
}

.doctor-card {
    background: rgba(255, 255, 255, 0.9);
    backdrop-filter: blur(10px);
    border-radius: 16px;
    padding: 32px;
    transition: all 0.3s ease;
    box-shadow: 0 4px 12px rgba(12, 35, 64, 0.08);
}

.doctor-header {
    position: relative;
    margin-bottom: 24px;
    text-align: center;
    padding: 16px;
}

.doctor-image {
    width: 150px;
    height: 150px;
    border-radius: 50%;
    margin-bottom: 30px;
    border: 3px solid #0C2340;
    object-fit: cover;
}

.doctor-badge {
    position: absolute;
    bottom: -8px;
    left: 50%;
    transform: translateX(-50%);
    background: #2C5494;
    color: white;
    padding: 8px 50px;
    border-radius: 20px;
    font-size: 0.9rem;
    font-weight: 500;
    box-shadow: 0 2px 8px rgba(12, 35, 64, 0.1);
    white-space: nowrap;
}

.doctor-name {
    font-size: 22px;
    margin-bottom: 16px;
    color: #0C2340;
}

.doctor-stats {
    display: flex;
    justify-content: center;
    gap: 20px;
    margin: 15px 0;
}

.stat {
    display: flex;
    align-items: center;
    gap: 8px;
    color: #0C2340;
}

.star-rating {
    color: #FFD700;
    display: flex;
    gap: 2px;
}

.star-rating i {
    font-size: 16px;
}

.doctor-actions {
    display: flex;
    flex-direction: column;
    gap: 12px;
    margin-top: 24px;
}

.btn-primary, .btn-secondary {
    padding: 12px 20px;
    border-radius: 8px;
    border: none;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    transition: all 0.3s ease;
    color: white;
    font-weight: 500;
}

.btn-primary {
    background: #0C2340;
}

.btn-secondary {
    background: #1B3B66;
}

/* Modal Styles */
.modal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(12, 35, 64, 0.9);
    backdrop-filter: blur(8px);
    z-index: 1000;
}

.modal-content {
    background: white;
    border-radius: 16px;
    max-width: 800px;
    width: 100%;
    margin: 5vh auto;
    padding: 24px;
    box-shadow: 0 8px 32px rgba(12, 35, 64, 0.2);
    max-height: 100vh;
    overflow-y: auto;
}

.modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
    padding-bottom: 12px;
    border-bottom: 2px solid rgba(12, 35, 64, 0.1);
}

.close-btn {
    background: none;
    border: none;
    font-size: 24px;
    cursor: pointer;
    color: #0C2340;
    transition: transform 0.3s ease;
}

/* Schedule Styles */
.schedule-container {
    background: white;
    border-radius: 12px;
    padding: 24px;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    max-width: 100%;
    overflow: hidden;
}

.schedule-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 24px;
}

.schedule-nav-btn {
    background: #0C2340;
    color: white;
    border: none;
    width: 36px;
    height: 36px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: all 0.3s ease;
}

.schedule-nav-btn:hover {
    background: #1B3B66;
    transform: scale(1.1);
}

#monthDisplay {
    font-size: 24px;
    font-weight: 600;
    color: #0C2340;
}

.schedule-weekdays {
    display: grid;
    grid-template-columns: repeat(7, 1fr);
    text-align: center;
    font-weight: 600;
    color: #1B3B66;
    margin-bottom: 16px;
    padding: 8px 0;
    border-bottom: 2px solid #f0f0f0;
}

.schedule-days {
    display: grid;
    grid-template-columns: repeat(7, 1fr);
    gap: 8px;
    padding: 8px;
}

.schedule-day {
    width: 100%;
    min-height: 60px;
    max-height: 80px;
    border-radius: 10px;
    padding: 8px;
    display: flex;
    flex-direction: column;
    align-items: center;
    background: #F8F9FA;
    border: 1px solid #E0E0E0;
    transition: all 0.3s ease;
    cursor: pointer;
    overflow: hidden;
}

.schedule-day.available {
    background: rgba(44, 84, 148, 0.1);
    border-color: #2C5494;
    color: #0C2340;
}

.schedule-day.available:hover {
    transform: scale(1.05);
    box-shadow: 0 4px 12px rgba(44, 84, 148, 0.2);
}

.schedule-day span {
    font-size: 16px;
    font-weight: 600;
    margin-bottom: 4px;
}

.time-slots {
    font-size: 11px;
    line-height: 1.4;
    text-align: center;
    color: #2C5494;
}

.time-picker {
    padding: 12px;
    border: 1px solid #E0E0E0;
    border-radius: 8px;
    font-size: 14px;
    width: 100%;
    color: #0C2340;
    background-color: white;
}

.time-picker::-webkit-calendar-picker-indicator {
    background-color: #0C2340;
    padding: 5px;
    cursor: pointer;
    border-radius: 3px;
}


/* Booking Form Styles */
.booking-form {
    display: flex;
    flex-direction: column;
    gap: 20px;
}

.form-group {
    display: flex;
    flex-direction: column;
    gap: 8px;
}

.form-group label {
    font-weight: 500;
    color: #0C2340;
}

.form-group input,
.form-group select,
.form-group textarea {
    padding: 12px;
    border: 1px solid #E0E0E0;
    border-radius: 8px;
    font-size: 14px;
}

.form-group textarea {
    height: 100px;
    resize: vertical;
}

/* Responsive Design */
@media (max-width: 768px) {
    .doctors-grid {
        grid-template-columns: 1fr;
    }
    
    .modal-content {
        width: 95%;
        padding: 16px;
    }
    
    .schedule-day {
        min-height: 50px;
        padding: 4px;
    }
    
    .schedule-day span {
        font-size: 14px;
    }
    
    .time-slots {
        font-size: 9px;
    }
}


</style>

<div class="doctors-grid">
    {% for doctor in doctors %}
    <div class="doctor-card stat-card">
        <div class="doctor-header">
            <img src="{% static 'health/images/doctor2.png' %}" alt="{{ doctor.name }}" class="doctor-image">
            <div class="doctor-badge">{{ doctor.specialization }}</div>
        </div>
        <div class="doctor-info">
            <h3 class="doctor-name">{{ doctor.name }}</h3>
            <div class="doctor-stats">
                <div class="stat">
                    <i class="fas fa-user-md"></i>
                    <span>{{ doctor.experience }} Years</span>
                </div>
                <div class="stat">
                    <div class="star-rating">
                        <i class="fas fa-star"></i>
                        <i class="fas fa-star"></i>
                        <i class="fas fa-star"></i>
                        <i class="fas fa-star"></i>
                        <i class="fas fa-star-half-alt"></i>
                    </div>
                </div>                
            </div>
            <div class="doctor-actions">
                <button class="btn-primary btn-availability" 
                        data-schedule="{{ doctor.schedule|safe }}" 
                        data-doctorid="{{ doctor.id }}">
                    <i class="fas fa-calendar-alt"></i>
                    Check Availability
                </button>
                <button class="btn-secondary btn-book" data-doctorid="{{ doctor.id }}">
                    <i class="fas fa-clock"></i>
                    Book Appointment
                </button>
            </div>
        </div>
    </div>
    {% endfor %}
</div>
<div id="availabilityModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2>Doctor's Schedule</h2>
            <button class="close-btn">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="schedule-container">
            <div class="schedule-header">
                <button id="prevMonth" class="schedule-nav-btn">
                    <i class="fas fa-chevron-left"></i>
                </button>
                <h3 id="monthDisplay"></h3>
                <button id="nextMonth" class="schedule-nav-btn">
                    <i class="fas fa-chevron-right"></i>
                </button>
            </div>
            <div class="schedule-weekdays">
                <div>Sun</div><div>Mon</div><div>Tue</div><div>Wed</div>
                <div>Thu</div><div>Fri</div><div>Sat</div>
            </div>
            <div id="scheduleDays" class="schedule-days"></div>
        </div>
    </div>
</div>
<div id="bookingModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2>Book Appointment</h2>
            <button class="close-btn" id="closeBooking">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <form id="appointmentForm" class="booking-form">
            {% csrf_token %}
            <input type="hidden" id="doctorId" name="doctor_id">            
            <div class="form-group">
                <label for="patientId">Patient ID</label>
                <input type="text" id="patientId" name="patient_id" required placeholder="Enter your Patient ID">
            </div>
        
            <div class="form-group">
                <label for="appointmentDate">Appointment Date</label>
                <input type="date" id="appointmentDate" name="appointment_date" required>
            </div>
        
            <!-- Replace the current appointment time select with this -->
            <div class="form-group">
                <label for="appointmentTime">Appointment Time</label>
                <input type="time" 
                    id="appointmentTime" 
                    name="appointment_time" 
                    required 
                    step="1"
                    min="09:00:00"
                    max="17:00:00"
                    class="time-picker">
            </div>

            
            
        
            <div class="form-group">
                <label for="status">Status</label>
                <select id="status" name="status" required>
                    <option value="pending">Pending</option>
                </select>
            </div>
        
            <button type="submit" class="btn-primary">Book Appointment</button>
        </form>
        
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const availabilityButtons = document.querySelectorAll('.btn-availability');
    const availabilityModal = document.getElementById('availabilityModal');
    const bookButtons = document.querySelectorAll('.btn-book');
    const bookingModal = document.getElementById('bookingModal');
    const closeButtons = document.querySelectorAll('.close-btn');
    const appointmentForm = document.getElementById('appointmentForm');

    // Initialize button click handlers
    availabilityButtons.forEach(button => {
        button.addEventListener('click', function() {
            try {
                const scheduleData = this.getAttribute('data-schedule');
                const schedule = JSON.parse(scheduleData.replace(/'/g, '"'));
                showAvailability(schedule);
                availabilityModal.style.display = 'block';
            } catch (error) {
                console.error('Error loading schedule:', error);
                showAlert('Unable to load doctor\'s schedule');
            }
        });
    });

    bookButtons.forEach(button => {
        button.addEventListener('click', function() {
            const doctorId = this.getAttribute('data-doctorid');
            const scheduleData = this.closest('.doctor-card').querySelector('.btn-availability').dataset.schedule;
            
            document.getElementById('doctorId').value = doctorId;
            document.getElementById('appointmentDate').dataset.schedule = scheduleData;
            
            bookingModal.style.display = 'block';
        });
    });

    // Close button handlers
    closeButtons.forEach(button => {
        button.addEventListener('click', () => closeAllModals());
    });

    // Date change handler
    document.getElementById('appointmentDate').addEventListener('change', function() {
        const scheduleData = this.dataset.schedule.replace(/'/g, '"');
        const schedule = JSON.parse(scheduleData);
        
        const selectedDate = new Date(this.value);
        const dayName = selectedDate.toLocaleString('en-us', {weekday: 'long'});
        const availableTimes = schedule[dayName] || [];
        
        const timeSelect =document.getElementById('appointmentTime').addEventListener('change', function() {
    const time = this.value;
    if (time) {
        // Split the time into hours and minutes
        const [hours, minutes] = time.split(':');
        // Format with seconds in correct pattern
        this.value = `${hours}:${minutes}:00`;
    }
});


    });

    // Form submission handler
    appointmentForm.addEventListener('submit', async function(e) {
    e.preventDefault();
    const formData = new FormData(this);
    
    // Log form data for verification
    console.log('Patient ID:', formData.get('patient_id'));
    console.log('Doctor ID:', formData.get('doctor_id'));
    console.log('Date:', formData.get('appointment_date'));
    console.log('Time:', formData.get('appointment_time'));

    try {
        const response = await fetch('/api/book-appointment/', {
            method: 'POST',
            headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
            },
            body: formData
        });

        const data = await response.json();
        
        if (data.success) {
            showAlert('Appointment booked successfully!', 'success');
            closeAllModals();
            this.reset();
        } else {
            showAlert(data.error || 'Failed to book appointment');
        }
    } catch (error) {
        console.error('Booking error:', error);
        showAlert('An error occurred while booking the appointment');
    }
});



    // Schedule initialization
    function showAvailability(schedule) {
        initSchedule(schedule);
    }

    function initSchedule(schedule) {
        const scheduleContainer = document.getElementById('scheduleDays');
        const monthDisplay = document.getElementById('monthDisplay');
        let currentDate = new Date();
        
        function renderSchedule() {
            const firstDay = new Date(currentDate.getFullYear(), currentDate.getMonth(), 1);
            const lastDay = new Date(currentDate.getFullYear(), currentDate.getMonth() + 1, 0);
            
            monthDisplay.textContent = `${currentDate.toLocaleString('default', { month: 'long' })} ${currentDate.getFullYear()}`;
            scheduleContainer.innerHTML = '';
            
            // Add empty cells for days before the first day of the month
            for(let i = 0; i < firstDay.getDay(); i++) {
                scheduleContainer.innerHTML += '<div></div>';
            }
            
            // Render days
            for(let day = 1; day <= lastDay.getDate(); day++) {
                const date = new Date(currentDate.getFullYear(), currentDate.getMonth(), day);
                const dayName = date.toLocaleString('en-us', {weekday: 'long'});
                const availableTimes = schedule[dayName] || [];
                const isAvailable = availableTimes.length > 0;
                
                scheduleContainer.innerHTML += `
                    <div class="schedule-day ${isAvailable ? 'available' : ''}" 
                         ${isAvailable ? `data-times='${JSON.stringify(availableTimes)}'` : ''}>
                        <span>${day}</span>
                        ${isAvailable ? `<div class="time-slots">${availableTimes.join('<br>')}</div>` : ''}
                    </div>
                `;
            }
        }

        // Month navigation
        document.getElementById('prevMonth').addEventListener('click', () => {
            currentDate.setMonth(currentDate.getMonth() - 1);
            renderSchedule();
        });
        
        document.getElementById('nextMonth').addEventListener('click', () => {
            currentDate.setMonth(currentDate.getMonth() + 1);
            renderSchedule();
        });
        
        renderSchedule();
    }

    // Utility functions
    function showAlert(message, type = 'error') {
        const alertBox = document.createElement('div');
        alertBox.classList.add('alert', `alert-${type}`);
        alertBox.textContent = message;
        document.body.appendChild(alertBox);
        setTimeout(() => alertBox.remove(), 3000);
    }

    function closeAllModals() {
        document.querySelectorAll('.modal').forEach(modal => {
            modal.style.display = 'none';
        });
    }

    // Global modal click-outside-to-close
    window.addEventListener('click', function(event) {
        if (event.target.classList.contains('modal')) {
            closeAllModals();
        }
    });

    // Escape key handler
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
            closeAllModals();
        }
    });
});
</script>
{% endblock %}
